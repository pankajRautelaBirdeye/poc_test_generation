name: Auto Test Generation (OpenAI)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install JavaParser
        run: mvn dependency:resolve

      - name: Build scanner
        run: mvn -q -DskipTests package

      - name: Scan project for annotated APIs
        run: java -cp target/classes com.example.poc_test_generation.tools.ScanAnnotations

      - name: Generate test cases using OpenAI
        run: |
          jq -c '.[]' methods.json | while read method; do
            echo "Processing method..."
            BODY=$(jq -n --arg input "$method" '{input:$input}')

            curl https://api.openai.com/v1/responses \
              -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"model\": \"gpt-4o-mini\",
                \"input\": [
                  {
                    \"role\": \"system\",
                    \"content\": \"You generate ONLY JUnit5 test classes. Return EXACTLY one Java code block.\"
                  },
                  {
                    \"role\": \"user\",
                    \"content\": $method
                  }
                ]
              }" > raw_output.json

            cat raw_output.json >> combined_output.json
          done

      - name: Write test files
        run: java -cp target/classes com.example.poc_test_generation.tools.WriteGeneratedTests

      - name: Commit & Push Generated Tests
        run: |
          git config user.email "bot@example.com"
          git config user.name "OpenAI Bot"
          git add src/test/java || true
          git commit -m "âœ… Auto-generated tests" || true
          git push || true
