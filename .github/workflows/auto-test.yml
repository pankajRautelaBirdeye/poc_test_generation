name: Auto Test Generation

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  generate-tests:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # Checkout code
      # -------------------------------
      - uses: actions/checkout@v4

      # -------------------------------
      # Setup Java
      # -------------------------------
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # -------------------------------
      # Build project (scanner + writer classes)
      # -------------------------------
      - name: Build classes
        run: mvn -q -DskipTests package

      # -------------------------------
      # Build Maven classpath (includes Jackson)
      # -------------------------------
      - name: Build classpath
        run: mvn -q -DincludeScope=runtime dependency:build-classpath -Dmdep.outputFile=cp.txt

      # -------------------------------
      # Run Annotation Scanner (Java)
      # -------------------------------
      - name: Scan for annotated APIs
        run: |
          CP=$(cat cp.txt):target/classes
          java -cp "$CP" com.example.poc_test_generation.tools.ScanAnnotations > methods.json

      - name: Print methods.json
        run: cat methods.json

      # -------------------------------
      # Call GitHub Copilot Chat API
      # -------------------------------
      - name: Generate Tests using GitHub Copilot Chat API
        run: |
          echo "Calling Copilot Chat API..."
          curl -s -X POST https://api.github.com/copilot/chat/completions \
            -H "Authorization: Bearer ${{ secrets.GH_COPILOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
                  --arg methods "$(cat methods.json)" \
                  '{
                    model: "gpt-4o-copilot",
                    messages: [
                      {role: "system", content: "You generate JUnit tests."},
                      {role: "user", content: ("Generate JUnit tests for: " + $methods)}
                    ]
                  }')" \
            > generated.json

      - name: Print Copilot Response
        run: cat generated.json

      # -------------------------------
      # Write Test Files (Java writer)
      # -------------------------------
      - name: Write generated test files
        run: |
          CP=$(cat cp.txt):target/classes
          java -cp "$CP" com.example.poc_test_generation.tools.WriteGeneratedTests

      # -------------------------------
      # Commit & Push Test Files
      # -------------------------------
      - name: Commit & Push Generated Tests
        run: |
          git config user.email "copilot-bot@example.com"
          git config user.name "Copilot Bot"

          git add src/test/java || true
          git commit -m "Auto-generated test cases by Copilot Chat API" || true
          git push || true
