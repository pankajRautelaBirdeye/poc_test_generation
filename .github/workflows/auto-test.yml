name: Auto Test Generation

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  generate-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build tools
        run: mvn -q -DskipTests package

      # -------------------------------
      # Build full classpath (fix for Jackson missing)
      # -------------------------------
      - name: Build classpath
        run: mvn -q -DincludeScope=runtime dependency:build-classpath -Dmdep.outputFile=cp.txt

      # -------------------------------
      # Run annotation scanner (Java)
      # -------------------------------
      - name: Scan for annotated APIs
        run: |
          CP=$(cat cp.txt):target/classes
          java -cp "$CP" com.example.poc_test_generation.tools.ScanAnnotations > methods.json

      - name: Print detected APIs
        run: cat methods.json

      # -------------------------------
      # Call Copilot Test Generation API
      # -------------------------------
      - name: Call GitHub Copilot Test Generation API
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GH_COPILOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @methods.json \
            https://api.github.com/copilot/test-generation \
            > generated.json

      - name: Show Copilot Output
        run: cat generated.json

      # -------------------------------
      # Run Java writer to create test files
      # -------------------------------
      - name: Write generated test files
        run: |
          CP=$(cat cp.txt):target/classes
          java -cp "$CP" com.example.poc_test_generation.tools.WriteGeneratedTests

      # -------------------------------
      # Commit & push generated tests
      # -------------------------------
      - name: Commit & Push Generated Tests
        run: |
          git config user.email "copilot-bot@example.com"
          git config user.name "Copilot Bot"

          git add src/test/java || true
          git commit -m "Auto-generated test cases by Copilot" || true
          git push || true
